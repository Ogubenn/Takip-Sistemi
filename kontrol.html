<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Bina KontrolÃ¼ - Bulancak AtÄ±ksu ArÄ±tma Tesisi</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container control-page">
        <header style="margin-bottom: 20px;">
            <div class="header-logo">
                <img src="assets/images/logo.jpg" alt="Bulancak Belediyesi" class="logo">
            </div>
            <h1 style="font-size: 1.5em; margin-bottom: 5px;">Bulancak AtÄ±ksu ArÄ±tma Tesisi</h1>
        </header>
        <div class="control-header">
            <div>
                <h2 id="buildingName">Bina KontrolÃ¼</h2>
                <p id="buildingInfo">GÃ¼nlÃ¼k kontrol listesi</p>
            </div>
            <div class="date-time">
                <p><strong>Tarih:</strong></p>
                <p id="currentDateTime"></p>
            </div>
        </div>

        <div id="successMessage" class="success-message">
            âœ“ Kontrol baÅŸarÄ±yla kaydedildi!
        </div>

        <div id="alreadyDoneMessage" class="info-message" style="display: none;">
            â„¹ï¸ Bu binanÄ±n bugÃ¼nkÃ¼ kontrolÃ¼ zaten yapÄ±lmÄ±ÅŸ. Ä°sterseniz gÃ¼ncelleyebilirsiniz.
        </div>

        <div class="checklist">
            <h3>ğŸ“‹ Kontrol Listesi</h3>
            <div id="checklistItems">
                <!-- Kontrol maddeleri JavaScript ile yÃ¼klenecek -->
            </div>
        </div>

        <div class="notes-section">
            <h3>ğŸ“ Notlar ve GÃ¶zlemler</h3>
            <textarea id="notes" placeholder="Varsa Ã¶nemli notlar, gÃ¶zlemler veya sorunlarÄ± buraya yazÄ±n..."></textarea>
        </div>

        <div class="action-buttons">
            <button class="btn btn-primary" onclick="saveControl()">ğŸ’¾ KontrolÃ¼ Kaydet</button>
            <button class="btn btn-secondary" onclick="goBack()">â† Ana Sayfaya DÃ¶n</button>
        </div>
    </div>

    <script src="js/script.js"></script>
    <script>
        // Session'dan kullanÄ±cÄ± bilgisini al
        function getCurrentUser() {
            const session = localStorage.getItem('admin_session') || sessionStorage.getItem('admin_session');
            if (session) {
                return JSON.parse(session);
            }
            return null;
        }

        // Bina bilgileri ve kontrol listeleri
        const buildingData = {
            giris: {
                name: "ğŸ¢ GiriÅŸ BinasÄ±",
                info: "Ana giriÅŸ binasÄ± kontrol listesi",
                checklist: [
                    "GiriÅŸ kapÄ±sÄ± ve gÃ¼venlik kontrol edildi",
                    "AydÄ±nlatma sistemi Ã§alÄ±ÅŸÄ±yor",
                    "Alarm sistemi kontrol edildi",
                    "YangÄ±n sÃ¶ndÃ¼rme cihazlarÄ± yerinde",
                    "Ä°lk yardÄ±m malzemeleri kontrol edildi",
                    "Zemin temiz ve gÃ¼venli",
                    "Elektrik panosu normal Ã§alÄ±ÅŸÄ±yor",
                    "Klima/IsÄ±tma sistemi Ã§alÄ±ÅŸÄ±yor",
                    "Ä°letiÅŸim sistemleri aktif",
                    "Acil Ã§Ä±kÄ±ÅŸ yollarÄ± aÃ§Ä±k ve iÅŸaretli"
                ]
            },
            kum_yag: {
                name: "ğŸª¨ Kum ve YaÄŸ Tutucu",
                info: "Kum ve yaÄŸ tutucu kontrol listesi",
                checklist: [
                    "Kum tutucusu kontrol edildi",
                    "YaÄŸ tutucu yÃ¼zey temiz",
                    "Su seviyesi normal",
                    "SÄ±zÄ±ntÄ± kontrolÃ¼ yapÄ±ldÄ±",
                    "Mekanik sistemler Ã§alÄ±ÅŸÄ±yor",
                    "Temizlik periyodu kontrol edildi",
                    "Boru baÄŸlantÄ±larÄ± sÄ±kÄ±",
                    "Vanalar sorunsuz Ã§alÄ±ÅŸÄ±yor",
                    "Koku kontrolÃ¼ yapÄ±ldÄ±",
                    "Genel temizlik uygun"
                ]
            },
            idari: {
                name: "ğŸ—ï¸ Ä°dari Bina",
                info: "Ä°dari bina kontrol listesi",
                checklist: [
                    "Ofis alanlarÄ± temiz ve dÃ¼zenli",
                    "Elektrik ve aydÄ±nlatma sistemleri Ã§alÄ±ÅŸÄ±yor",
                    "Ä°klim kontrol sistemi normal",
                    "GÃ¼venlik sistemleri aktif",
                    "Ä°letiÅŸim sistemleri Ã§alÄ±ÅŸÄ±yor",
                    "Bilgisayar ve yazÄ±cÄ±lar kontrol edildi",
                    "ToplantÄ± odasÄ± hazÄ±r",
                    "Mutfak ve dinlenme alanÄ± temiz",
                    "Tuvaletler temiz ve malzemeler yeterli",
                    "Acil Ã§Ä±kÄ±ÅŸ yollarÄ± aÃ§Ä±k"
                ]
            },
            blower: {
                name: "ğŸŒ¬ï¸ Blower OdasÄ±",
                info: "Blower odasÄ± kontrol listesi",
                checklist: [
                    "Blower Ã¼nitesi Ã§alÄ±ÅŸÄ±yor",
                    "Motor sÄ±caklÄ±ÄŸÄ± normal",
                    "YaÄŸ seviyeleri kontrol edildi",
                    "TitreÅŸim ve ses seviyesi normal",
                    "Elektrik deÄŸerleri Ã¶lÃ§Ã¼ldÃ¼",
                    "Hava filtreleri kontrol edildi",
                    "Hava basÄ±ncÄ± uygun",
                    "KayÄ±ÅŸ gerginlikleri kontrol edildi",
                    "SÄ±zÄ±ntÄ± ve kaÃ§ak yok",
                    "Otomasyon sistemi Ã§alÄ±ÅŸÄ±yor"
                ]
            },
            test1: {
                name: "ğŸ§ª Test Oda 1",
                info: "Test odasÄ± 1 kontrol listesi",
                checklist: [
                    "Test ekipmanlarÄ± Ã§alÄ±ÅŸÄ±r durumda",
                    "Numune alma iÅŸlemi yapÄ±ldÄ±",
                    "pH metre kalibre edildi",
                    "SÄ±caklÄ±k Ã¶lÃ§Ã¼mleri normal",
                    "Kimyasal stoklar yeterli",
                    "GÃ¼venlik ekipmanlarÄ± yerinde",
                    "HavalandÄ±rma sistemi Ã§alÄ±ÅŸÄ±yor",
                    "AtÄ±k bertaraf sistemi kontrol edildi",
                    "Temizlik ve hijyen saÄŸlandÄ±",
                    "KayÄ±tlar dÃ¼zenli tutuluyor"
                ]
            },
            test2: {
                name: "ğŸ§ª Test Oda 2",
                info: "Test odasÄ± 2 kontrol listesi",
                checklist: [
                    "Test ekipmanlarÄ± Ã§alÄ±ÅŸÄ±r durumda",
                    "Numune alma iÅŸlemi yapÄ±ldÄ±",
                    "Analiz cihazlarÄ± kalibrasyonda",
                    "Reaktif ve kimyasallar yeterli",
                    "SÄ±caklÄ±k ve nem kontrolÃ¼ yapÄ±ldÄ±",
                    "GÃ¼venlik protokolleri uygulandÄ±",
                    "Temizlik ve sterilizasyon yapÄ±ldÄ±",
                    "Veri kayÄ±t sistemi aktif",
                    "HavalandÄ±rma sistemi Ã§alÄ±ÅŸÄ±yor",
                    "Acil durum ekipmanlarÄ± hazÄ±r"
                ]
            },
            test3: {
                name: "ğŸ§ª Test Oda 3",
                info: "Test odasÄ± 3 kontrol listesi",
                checklist: [
                    "Laboratuvar ekipmanlarÄ± kontrol edildi",
                    "Numune hazÄ±rlama alanÄ± temiz",
                    "Ã–lÃ§Ã¼m cihazlarÄ± Ã§alÄ±ÅŸÄ±yor",
                    "BuzdolabÄ± sÄ±caklÄ±ÄŸÄ± uygun",
                    "Kimyasal depolama dÃ¼zenli",
                    "Koruyucu ekipmanlar yeterli",
                    "Ä°lk yardÄ±m malzemeleri mevcut",
                    "Elektrik ve su sistemi normal",
                    "AtÄ±k yÃ¶netimi uygun",
                    "KayÄ±t ve raporlama gÃ¼ncel"
                ]
            },
            test4: {
                name: "ğŸ§ª Test Oda 4",
                info: "Test odasÄ± 4 kontrol listesi",
                checklist: [
                    "Test Ã¼niteleri operasyonel",
                    "Kalibrasyon kontrolleri yapÄ±ldÄ±",
                    "Numune saklama koÅŸullarÄ± uygun",
                    "Analiz sonuÃ§larÄ± kaydedildi",
                    "Kimyasal seviyeler kontrol edildi",
                    "GÃ¼venlik duÅŸu ve gÃ¶z yÄ±kama fonksiyonel",
                    "HavalandÄ±rma ve filtrasyon aktif",
                    "Temizlik prosedÃ¼rleri tamamlandÄ±",
                    "Acil mÃ¼dahale planÄ± gÃ¼ncel",
                    "Ekipman bakÄ±mlarÄ± zamanÄ±nda"
                ]
            }
        };

        // Sayfa yÃ¼klendiÄŸinde
        window.onload = function() {
            // URL'den bina ID'sini al
            const urlParams = new URLSearchParams(window.location.search);
            const buildingId = urlParams.get('bina');

            if (!buildingId || !buildingData[buildingId]) {
                alert('GeÃ§ersiz bina seÃ§imi!');
                window.location.href = 'index.html';
                return;
            }

            const building = buildingData[buildingId];

            // Bina bilgilerini gÃ¶ster
            document.getElementById('buildingName').textContent = building.name;
            document.getElementById('buildingInfo').textContent = building.info;
            document.getElementById('currentDateTime').textContent = formatDateTime();

            // Kontrol listesini oluÅŸtur
            const checklistContainer = document.getElementById('checklistItems');
            building.checklist.forEach((item, index) => {
                const checkItem = document.createElement('div');
                checkItem.className = 'check-item';
                checkItem.innerHTML = `
                    <input type="checkbox" id="check${index}" onchange="updateCheckItem(this)">
                    <label for="check${index}">${item}</label>
                `;
                checklistContainer.appendChild(checkItem);
            });

            // KayÄ±tlÄ± verileri yÃ¼kle
            loadSavedData(buildingId);
            
            // BugÃ¼n zaten yapÄ±lmÄ±ÅŸ mÄ± kontrol et
            checkIfAlreadyDone(buildingId);
        };

        // BugÃ¼n zaten yapÄ±lmÄ±ÅŸ mÄ± kontrol et
        function checkIfAlreadyDone(buildingId) {
            if (isTodayControlDone(buildingId)) {
                const message = document.getElementById('alreadyDoneMessage');
                if (message) {
                    message.style.display = 'block';
                }
            }
        }

        // Checkbox durumu deÄŸiÅŸtiÄŸinde
        function updateCheckItem(checkbox) {
            const checkItem = checkbox.parentElement;
            if (checkbox.checked) {
                checkItem.classList.add('checked');
            } else {
                checkItem.classList.remove('checked');
            }
        }

        // KontrolÃ¼ kaydet
        function saveControl() {
            const urlParams = new URLSearchParams(window.location.search);
            const buildingId = urlParams.get('bina');

            // TÃ¼m checkbox'larÄ± topla
            const checkboxes = document.querySelectorAll('#checklistItems input[type="checkbox"]');
            const checkedItems = [];
            let checkedCount = 0;
            
            checkboxes.forEach((checkbox, index) => {
                if (checkbox.checked) checkedCount++;
                checkedItems.push({
                    index: index,
                    checked: checkbox.checked,
                    label: checkbox.nextElementSibling.textContent
                });
            });

            // NotlarÄ± al
            const notes = document.getElementById('notes').value;

            // Tamamlanma yÃ¼zdesi
            const completionRate = ((checkedCount / checkboxes.length) * 100).toFixed(0);

            // KullanÄ±cÄ± bilgisini al
            const currentUser = getCurrentUser();
            const userName = currentUser ? currentUser.fullName : 'Anonim KullanÄ±cÄ±';
            const userId = currentUser ? currentUser.userId : null;

            // Veriyi kaydet
            const controlData = {
                buildingId: buildingId,
                buildingName: buildingData[buildingId].name,
                date: getTodayDate(),
                savedAt: new Date().toISOString(),
                checkedItems: checkedItems,
                notes: notes,
                completedBy: userName,
                userId: userId,
                userRole: currentUser ? currentUser.role : null,
                completed: true,
                checkedCount: checkedCount,
                totalCount: checkboxes.length,
                completionRate: completionRate
            };

            saveControlData(buildingId, controlData);
            showSuccessMessage();
            
            // 2 saniye sonra ana sayfaya dÃ¶n
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 2000);
        }

        // KayÄ±tlÄ± verileri yÃ¼kle
        function loadSavedData(buildingId) {
            const savedData = loadControlData(buildingId);
            if (savedData) {
                // Checkbox'larÄ± iÅŸaretle
                savedData.checkedItems.forEach(item => {
                    const checkbox = document.getElementById(`check${item.index}`);
                    if (checkbox) {
                        checkbox.checked = item.checked;
                        updateCheckItem(checkbox);
                    }
                });

                // NotlarÄ± yÃ¼kle
                document.getElementById('notes').value = savedData.notes || '';
            }
        }

        // Ana sayfaya dÃ¶n
        function goBack() {
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
