<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>ƒ∞statistikler - Bulancak Atƒ±ksu Arƒ±tma Tesisi</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="config.js"></script>
    <script src="js/script.js"></script>
    <style>
        .stats-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 12px;
            color: white;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-box:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .chart-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .chart-title {
            color: #667eea;
            font-size: 1.5em;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .building-stats {
            display: grid;
            gap: 15px;
        }

        .building-stat-row {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .building-stat-name {
            flex: 0 0 200px;
            font-weight: 600;
            color: #333;
        }

        .building-stat-bar {
            flex: 1;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .building-stat-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            transition: width 0.5s ease;
        }

        .period-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .period-btn {
            padding: 12px 25px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .period-btn:hover {
            background: #667eea;
            color: white;
        }

        .period-btn.active {
            background: #667eea;
            color: white;
        }

        .compliance-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .compliance-indicator.excellent {
            background: #28a745;
        }

        .compliance-indicator.good {
            background: #ffc107;
        }

        .compliance-indicator.poor {
            background: #dc3545;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .summary-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }

        .summary-card h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #ddd;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        /* Takvim Stilleri */
        .calendar-month {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .calendar-month-title {
            text-align: center;
            font-size: 1.2em;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 15px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            color: #666;
            padding: 8px;
            font-size: 0.9em;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }

        .calendar-day:hover:not(.empty) {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1;
        }

        .calendar-day.empty {
            background: transparent;
            cursor: default;
        }

        .calendar-day.future {
            background: #f8f9fa;
            border: 1px solid #ddd;
            color: #999;
        }

        .calendar-day.complete {
            background: #28a745;
            color: white;
        }

        .calendar-day.partial {
            background: #ffc107;
            color: #333;
        }

        .calendar-day.none {
            background: #dc3545;
            color: white;
        }

        .calendar-day.today {
            border: 3px solid #667eea;
            font-weight: 700;
        }
    </style>
</head>
<body>
    <div class="container stats-container">
        <header>
            <div class="header-logo">
                <img src="assets/images/logo.jpg" alt="Bulancak Belediyesi" class="logo">
            </div>
            <h1>üìä ƒ∞statistikler ve Raporlar</h1>
            <h2>Kontrol Verileri Analizi</h2>
        </header>

        <main style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);">
            
            <div class="period-selector">
                <button class="period-btn active" onclick="showTab('stats', this)">üìä ƒ∞statistikler</button>
                <button class="period-btn" onclick="showTab('calendar', this)">üìÖ Takvim G√∂r√ºn√ºm√º</button>
            </div>

            <div id="statsTab" style="display: block;">
                <div class="period-selector" style="margin-top: 20px;">
                    <button class="period-btn active" onclick="changePeriod('7', this)">Son 7 G√ºn</button>
                    <button class="period-btn" onclick="changePeriod('30', this)">Son 30 G√ºn</button>
                    <button class="period-btn" onclick="changePeriod('90', this)">Son 90 G√ºn</button>
                    <button class="period-btn" onclick="changePeriod('all', this)">T√ºm Zamanlar</button>
                </div>

            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-number" id="totalControls">0</div>
                    <div class="stat-label">Toplam Kontrol</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="avgCompletion">0%</div>
                    <div class="stat-label">Ortalama Tamamlanma</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="todayControls">0/4</div>
                    <div class="stat-label">Bug√ºn√ºn Kontrolleri</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="activeStreak">0</div>
                    <div class="stat-label">G√ºnl√ºk Seri</div>
                </div>
            </div>

            <div class="chart-section">
                <h3 class="chart-title">üè¢ Binalara G√∂re Kontrol Sayƒ±larƒ±</h3>
                <div class="building-stats" id="buildingStats">
                    <!-- JavaScript ile doldurulacak -->
                </div>
            </div>

            <div class="chart-section">
                <h3 class="chart-title">üìà Uyumluluk Oranlarƒ±</h3>
                <div class="building-stats" id="complianceStats">
                    <!-- JavaScript ile doldurulacak -->
                </div>
            </div>

            <div class="chart-section">
                <h3 class="chart-title">üë• Kullanƒ±cƒ± Performansƒ±</h3>
                <div class="building-stats" id="userPerformanceStats">
                    <!-- JavaScript ile doldurulacak -->
                </div>
            </div>

            <div class="summary-cards">
                <div class="summary-card">
                    <h4>üéØ En ƒ∞yi Performans</h4>
                    <div id="bestPerformance">
                        <div class="summary-item">
                            <span>Hesaplanƒ±yor...</span>
                        </div>
                    </div>
                </div>

                <div class="summary-card">
                    <h4>‚ö†Ô∏è Dikkat Gereken Alanlar</h4>
                    <div id="attentionAreas">
                        <div class="summary-item">
                            <span>Hesaplanƒ±yor...</span>
                        </div>
                    </div>
                </div>

                <div class="summary-card">
                    <h4>üìÖ Son Kontrol Tarihleri</h4>
                    <div id="lastControls">
                        <div class="summary-item">
                            <span>Y√ºkleniyor...</span>
                        </div>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <button class="btn btn-secondary" onclick="window.location.href='index.html'">
                    ‚Üê Ana Sayfaya D√∂n
                </button>
            </div>
            </div>
            <!-- statsTab sonu -->

            <!-- Takvim Sekmesi -->
            <div id="calendarTab" style="display: none;">
                <div style="text-align: center; margin-bottom: 30px;">
                    <button class="period-btn" onclick="changeCalendarYear(-1)">‚óÄ √ñnceki Yƒ±l</button>
                    <span style="font-size: 1.5em; font-weight: 600; margin: 0 20px;" id="calendarYear">2026</span>
                    <button class="period-btn" onclick="changeCalendarYear(1)">Sonraki Yƒ±l ‚ñ∂</button>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <div style="width: 20px; height: 20px; background: #28a745; border-radius: 3px;"></div>
                        <span>Tam Kontrol (%80+)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <div style="width: 20px; height: 20px; background: #ffc107; border-radius: 3px;"></div>
                        <span>Kƒ±smi Kontrol</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <div style="width: 20px; height: 20px; background: #dc3545; border-radius: 3px;"></div>
                        <span>Kontrol Yok</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <div style="width: 20px; height: 20px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 3px;"></div>
                        <span>Gelecek</span>
                    </div>
                </div>

                <div id="calendarContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <!-- Takvim aylarƒ± buraya y√ºklenecek -->
                </div>

                <div style="text-align: center; margin-top: 40px;">
                    <button class="btn btn-secondary" onclick="window.location.href='index.html'">
                        ‚Üê Ana Sayfaya D√∂n
                    </button>
                </div>
            </div>

        </main>
    </div>

    <script src="js/script.js"></script>
    <script>
        let currentPeriod = 7;

        // Sayfa y√ºklendiƒüinde
        window.onload = async function() {
            await loadStatistics();
        };

        // Periyot deƒüi≈ütir
        function changePeriod(days, btn) {
            // Sadece istatistik periyot butonlarƒ±nƒ± g√ºncelle (takvim butonlarƒ±nƒ± etkileme)
            const parentSelector = btn.closest('.period-selector');
            parentSelector.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentPeriod = days;
            loadStatistics();
        }

        // ƒ∞statistikleri y√ºkle (API'den)
        async function loadStatistics() {
            showLoading('ƒ∞statistikler y√ºkleniyor...');
            
            try {
                const response = await API.get('/controls/stats.php');
                
                hideLoading();
                
                if (response.success) {
                    displayStats(response);
                } else {
                    showError('ƒ∞statistikler y√ºklenemedi');
                }
            } catch (error) {
                hideLoading();
                console.error('ƒ∞statistikler y√ºklenemedi:', error);
                showError('ƒ∞statistikler y√ºklenirken hata olu≈ütu');
            }
        }

        // ƒ∞statistikleri g√∂ster
        function displayStats(data) {
            // Genel istatistikler
            document.getElementById('totalControls').textContent = data.totalControls || 0;
            document.getElementById('avgCompletion').textContent = (data.avgCompletionRate || 0) + '%';
            document.getElementById('todayControls').textContent = 
                `${data.todayControls ? data.todayControls.length : 0}/${data.activeBuildings || 0}`;
            document.getElementById('activeStreak').textContent = data.weeklyControls || 0;

            // Bina istatistikleri
            displayBuildingStats(data.buildingStats || []);
            
            // √ñzet kartlar
            displayBestPerformance(data.buildingStats || []);
            displayAttentionAreas(data.buildingStats || []);
            displayLastControls(data.buildingStats || []);
        }

        // Bina istatistiklerini g√∂ster
        function displayBuildingStats(buildings) {
            const buildingStatsContainer = document.getElementById('buildingStats');
            const complianceContainer = document.getElementById('complianceStats');
            
            buildingStatsContainer.innerHTML = '';
            complianceContainer.innerHTML = '';
            
            if (buildings.length === 0) {
                buildingStatsContainer.innerHTML = '<p style="text-align:center;padding:20px;color:#999;">Hen√ºz kontrol verisi yok</p>';
                return;
            }
            
            const maxCount = Math.max(...buildings.map(b => b.total_controls || 0));
            
            buildings.forEach(building => {
                const count = building.total_controls || 0;
                const completion = Math.round(building.avg_completion || 0);
                const percentage = maxCount > 0 ? (count / maxCount) * 100 : 0;
                
                // Kontrol sayƒ±sƒ± kartƒ±
                const countRow = document.createElement('div');
                countRow.className = 'building-stat-row';
                countRow.innerHTML = `
                    <div class="building-stat-name">${building.icon || 'üè¢'} ${building.name}</div>
                    <div class="building-stat-bar">
                        <div class="building-stat-fill" style="width: ${percentage}%">
                            ${count} kontrol
                        </div>
                    </div>
                `;
                buildingStatsContainer.appendChild(countRow);
                
                // Uyumluluk kartƒ±
                const compRow = document.createElement('div');
                compRow.className = 'building-stat-row';
                compRow.innerHTML = `
                    <div class="building-stat-name">${building.icon || 'üè¢'} ${building.name}</div>
                    <div class="building-stat-bar">
                        <div class="building-stat-fill" style="width: ${completion}%">
                            %${completion}
                        </div>
                    </div>
                `;
                complianceContainer.appendChild(compRow);
            });
        }

        // En iyi performans
        function displayBestPerformance(buildings) {
            const container = document.getElementById('bestPerformance');
            if (buildings.length === 0) {
                container.innerHTML = '<div class="summary-item"><span>Veri yok</span></div>';
                return;
            }
            
            const sorted = [...buildings].sort((a, b) => (b.avg_completion || 0) - (a.avg_completion || 0));
            const best = sorted[0];
            
            container.innerHTML = `
                <div class="summary-item">
                    <span>${best.icon || 'üè¢'} ${best.name}</span>
                    <strong style="color: #28a745;">%${Math.round(best.avg_completion || 0)}</strong>
                </div>
            `;
        }

        // Dikkat gereken alanlar
        function displayAttentionAreas(buildings) {
            const container = document.getElementById('attentionAreas');
            container.innerHTML = '';
            
            const needsAttention = buildings.filter(b => (b.avg_completion || 0) < 90);
            needsAttention.sort((a, b) => (a.avg_completion || 0) - (b.avg_completion || 0));
            
            if (needsAttention.length === 0) {
                container.innerHTML = '<div class="summary-item"><span style="color: #28a745;">‚úì T√ºm binalar m√ºkemmel!</span></div>';
                return;
            }
            
            needsAttention.forEach(building => {
                const item = document.createElement('div');
                item.className = 'summary-item';
                item.innerHTML = `
                    <span>${building.icon || 'üè¢'} ${building.name}</span>
                    <strong style="color: #dc3545;">%${Math.round(building.avg_completion || 0)}</strong>
                `;
                container.appendChild(item);
            });
        }

        // Son kontrol tarihleri
        function displayLastControls(buildings) {
            const container = document.getElementById('lastControls');
            container.innerHTML = '';
            
            buildings.forEach(building => {
                const item = document.createElement('div');
                item.className = 'summary-item';
                
                if (building.last_control) {
                    const date = new Date(building.last_control);
                    const today = new Date();
                    const diffDays = Math.floor((today - date) / (1000 * 60 * 60 * 24));
                    
                    let timeText = '';
                    if (diffDays === 0) timeText = 'Bug√ºn';
                    else if (diffDays === 1) timeText = 'D√ºn';
                    else timeText = `${diffDays} g√ºn √∂nce`;
                    
                    item.innerHTML = `
                        <span>${building.icon || 'üè¢'} ${building.name}</span>
                        <strong>${timeText}</strong>
                    `;
                } else {
                    item.innerHTML = `
                        <span>${building.icon || 'üè¢'} ${building.name}</span>
                        <strong style="color: #dc3545;">Kontrol yok</strong>
                    `;
                }
                
                container.appendChild(item);
            });
        }

        // Kullanƒ±cƒ± performansƒ± (hen√ºz API desteklemiyor, bo≈ü bƒ±rakƒ±yoruz)
        const userPerfContainer = document.getElementById('userPerformanceStats');
        if (userPerfContainer) {
            userPerfContainer.innerHTML = '<p style="text-align:center;padding:20px;color:#999;">Kullanƒ±cƒ± bazlƒ± istatistikler yakƒ±nda eklenecek</p>';
        }
    </script>
</body>
</html>

        // Periyot deƒüi≈ütir
        function changePeriod(days, btn) {
            // Aktif butonu deƒüi≈ütir
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            currentPeriod = days;
            loadStatistics();
        }

        // ƒ∞statistikleri y√ºkle
        function loadStatistics() {
            const stats = calculateStats();
            displayStats(stats);
        }

        // ƒ∞statistikleri hesapla
        function calculateStats() {
            const today = new Date();
            const cutoffDate = currentPeriod === 'all' ? new Date('2020-01-01') : 
                               new Date(today.getTime() - (currentPeriod * 24 * 60 * 60 * 1000));
            const cutoffDateStr = cutoffDate.toISOString().split('T')[0];

            let totalControls = 0;
            let totalCompletion = 0;
            let buildingCounts = {};
            let buildingCompletions = {};

            Object.keys(buildings).forEach(buildingId => {
                const controls = getAllControls(buildingId);
                const filteredControls = controls.filter(c => c.date >= cutoffDateStr && c.data);
                
                buildingCounts[buildingId] = filteredControls.length;
                totalControls += filteredControls.length;

                let buildingTotal = 0;
                filteredControls.forEach(control => {
                    if (control.data && control.data.completionRate) {
                        buildingTotal += parseFloat(control.data.completionRate);
                    }
                });

                buildingCompletions[buildingId] = filteredControls.length > 0 ? 
                    (buildingTotal / filteredControls.length).toFixed(1) : 0;
                
                totalCompletion += buildingTotal;
            });

            const avgCompletion = totalControls > 0 ? (totalCompletion / totalControls).toFixed(1) : 0;

            // Bug√ºn√ºn kontrolleri
            const todayStatus = getTodayStatus();
            const todayCompleted = Object.values(todayStatus).filter(v => v).length;

            // G√ºnl√ºk seri hesapla
            const streak = calculateStreak();

            return {
                totalControls,
                avgCompletion,
                todayCompleted,
                streak,
                buildingCounts,
                buildingCompletions
            };
        }

        // G√ºnl√ºk seri hesapla
        function calculateStreak() {
            let streak = 0;
            const today = new Date();
            
            for (let i = 0; i < 365; i++) {
                const checkDate = new Date(today.getTime() - (i * 24 * 60 * 60 * 1000));
                const dateStr = checkDate.toISOString().split('T')[0];
                
                let hasControlForDay = false;
                Object.keys(buildings).forEach(buildingId => {
                    const control = loadControlData(buildingId, dateStr);
                    if (control) {
                        hasControlForDay = true;
                    }
                });
                
                if (hasControlForDay) {
                    streak++;
                } else if (i > 0) { // ƒ∞lk g√ºn (bug√ºn) kontrol yoksa streaki kƒ±rma
                    break;
                }
            }
            
            return streak;
        }

        // ƒ∞statistikleri g√∂ster
        function displayStats(stats) {
            // Genel istatistikler
            document.getElementById('totalControls').textContent = stats.totalControls;
            document.getElementById('avgCompletion').textContent = stats.avgCompletion + '%';
            document.getElementById('todayControls').textContent = stats.todayCompleted + '/4';
            document.getElementById('activeStreak').textContent = stats.streak;

            // Bina istatistikleri
            const buildingStatsContainer = document.getElementById('buildingStats');
            buildingStatsContainer.innerHTML = '';
            
            Object.keys(buildings).forEach(buildingId => {
                const count = stats.buildingCounts[buildingId] || 0;
                const maxCount = Math.max(...Object.values(stats.buildingCounts));
                const percentage = maxCount > 0 ? (count / maxCount) * 100 : 0;
                
                const row = document.createElement('div');
                row.className = 'building-stat-row';
                row.innerHTML = `
                    <div class="building-stat-name">${buildings[buildingId]}</div>
                    <div class="building-stat-bar">
                        <div class="building-stat-fill" style="width: ${percentage}%">
                            ${count} kontrol
                        </div>
                    </div>
                `;
                buildingStatsContainer.appendChild(row);
            });

            // Uyumluluk oranlarƒ±
            const complianceContainer = document.getElementById('complianceStats');
            complianceContainer.innerHTML = '';
            
            Object.keys(buildings).forEach(buildingId => {
                const completion = stats.buildingCompletions[buildingId] || 0;
                const complianceClass = completion >= 90 ? 'excellent' : 
                                       completion >= 70 ? 'good' : 'poor';
                
                const row = document.createElement('div');
                row.className = 'building-stat-row';
                row.innerHTML = `
                    <div class="building-stat-name">
                        <span class="compliance-indicator ${complianceClass}"></span>
                        ${buildings[buildingId]}
                    </div>
                    <div class="building-stat-bar">
                        <div class="building-stat-fill" style="width: ${completion}%">
                            %${completion}
                        </div>
                    </div>
                `;
                complianceContainer.appendChild(row);
            });

            // Kullanƒ±cƒ± performans istatistikleri
            displayUserPerformance();

            // En iyi performans
            displayBestPerformance(stats);
            
            // Dikkat gereken alanlar
            displayAttentionAreas(stats);
            
            // Son kontrol tarihleri
            displayLastControls();
        }

        // Kullanƒ±cƒ± performans istatistikleri
        function displayUserPerformance() {
            const container = document.getElementById('userPerformanceStats');
            container.innerHTML = '';
            
            // T√ºm kontrolleri topla ve kullanƒ±cƒ±lara g√∂re grupla
            const userStats = {};
            
            Object.keys(buildings).forEach(buildingId => {
                const controls = getAllControls(buildingId);
                controls.forEach(control => {
                    const userName = control.data.completedBy || 'Anonim Kullanƒ±cƒ±';
                    
                    if (!userStats[userName]) {
                        userStats[userName] = {
                            totalControls: 0,
                            totalCompletion: 0,
                            buildings: new Set()
                        };
                    }
                    
                    userStats[userName].totalControls++;
                    userStats[userName].totalCompletion += parseInt(control.data.completionRate || 0);
                    userStats[userName].buildings.add(buildingId);
                });
            });
            
            // Kullanƒ±cƒ± sayƒ±sƒ± yoksa mesaj g√∂ster
            if (Object.keys(userStats).length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #999;">
                        <p>Hen√ºz kullanƒ±cƒ± bazlƒ± kontrol verisi bulunmamaktadƒ±r.</p>
                        <p style="font-size: 0.9em;">Admin panelden giri≈ü yaparak kontrol yapƒ±ldƒ±ƒüƒ±nda burada g√∂r√ºnecektir.</p>
                    </div>
                `;
                return;
            }
            
            // Kullanƒ±cƒ±larƒ± kontrol sayƒ±sƒ±na g√∂re sƒ±rala
            const sortedUsers = Object.entries(userStats)
                .sort((a, b) => b[1].totalControls - a[1].totalControls);
            
            sortedUsers.forEach(([userName, stats]) => {
                const avgCompletion = stats.totalControls > 0 
                    ? Math.round(stats.totalCompletion / stats.totalControls) 
                    : 0;
                
                const row = document.createElement('div');
                row.className = 'building-stat-row';
                row.innerHTML = `
                    <div class="building-stat-name">
                        üë§ ${userName}
                    </div>
                    <div style="flex: 1; display: flex; gap: 20px; align-items: center;">
                        <div style="flex: 1;">
                            <small style="color: #666;">Kontrol Sayƒ±sƒ±: <strong>${stats.totalControls}</strong></small><br>
                            <small style="color: #666;">Farklƒ± Bina: <strong>${stats.buildings.size}</strong></small>
                        </div>
                        <div class="building-stat-bar" style="flex: 2;">
                            <div class="building-stat-fill" style="width: ${avgCompletion}%">
                                Ort. %${avgCompletion}
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        // En iyi performans
        function displayBestPerformance(stats) {
            const container = document.getElementById('bestPerformance');
            const sorted = Object.entries(stats.buildingCompletions)
                .sort((a, b) => b[1] - a[1]);
            
            if (sorted.length > 0) {
                const [buildingId, completion] = sorted[0];
                container.innerHTML = `
                    <div class="summary-item">
                        <span>${buildings[buildingId]}</span>
                        <strong style="color: #28a745;">%${completion}</strong>
                    </div>
                `;
            }
        }

        // Dikkat gereken alanlar
        function displayAttentionAreas(stats) {
            const container = document.getElementById('attentionAreas');
            const sorted = Object.entries(stats.buildingCompletions)
                .sort((a, b) => a[1] - b[1]);
            
            container.innerHTML = '';
            
            sorted.forEach(([buildingId, completion]) => {
                if (completion < 90) {
                    const item = document.createElement('div');
                    item.className = 'summary-item';
                    item.innerHTML = `
                        <span>${buildings[buildingId]}</span>
                        <strong style="color: #dc3545;">%${completion}</strong>
                    `;
                    container.appendChild(item);
                }
            });
            
            if (container.children.length === 0) {
                container.innerHTML = '<div class="summary-item"><span style="color: #28a745;">‚úì T√ºm binalar m√ºkemmel durumda!</span></div>';
            }
        }

        // Son kontrol tarihleri
        function displayLastControls() {
            const container = document.getElementById('lastControls');
            container.innerHTML = '';
            
            Object.keys(buildings).forEach(buildingId => {
                const controls = getAllControls(buildingId);
                const lastControl = controls.length > 0 ? controls[0] : null;
                
                const item = document.createElement('div');
                item.className = 'summary-item';
                
                if (lastControl) {
                    const date = new Date(lastControl.date);
                    const today = new Date();
                    const diffDays = Math.floor((today - date) / (1000 * 60 * 60 * 24));
                    
                    let timeText = '';
                    if (diffDays === 0) timeText = 'Bug√ºn';
                    else if (diffDays === 1) timeText = 'D√ºn';
                    else timeText = `${diffDays} g√ºn √∂nce`;
                    
                    item.innerHTML = `
                        <span>${buildings[buildingId]}</span>
                        <strong>${timeText}</strong>
                    `;
                } else {
                    item.innerHTML = `
                        <span>${buildings[buildingId]}</span>
                        <strong style="color: #dc3545;">Kontrol yok</strong>
                    `;
                }
                
                container.appendChild(item);
            });
        }

        // Sekme deƒüi≈ütirme
        function showTab(tab, button) {
            console.log('showTab √ßaƒürƒ±ldƒ±:', tab);
            
            // Sadece ana sekme butonlarƒ±nƒ± g√ºncelle (period butonlarƒ±nƒ± etkileme)
            const parentSelector = button.closest('.period-selector');
            parentSelector.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            button.classList.add('active');

            // Sekmeleri g√∂ster/gizle
            const statsTab = document.getElementById('statsTab');
            const calendarTab = document.getElementById('calendarTab');
            
            console.log('statsTab:', statsTab, 'calendarTab:', calendarTab);
            
            if (tab === 'stats') {
                if (statsTab) statsTab.style.display = 'block';
                if (calendarTab) calendarTab.style.display = 'none';
            } else if (tab === 'calendar') {
                if (statsTab) statsTab.style.display = 'none';
                if (calendarTab) calendarTab.style.display = 'block';
                console.log('Takvim y√ºkleniyor...');
                loadCalendar();
            }
        }

        // Takvim y√ºkle
        let currentCalendarYear = new Date().getFullYear();
        
        async function loadCalendar() {
            console.log('loadCalendar ba≈üladƒ±, yƒ±l:', currentCalendarYear);
            try {
                document.getElementById('calendarYear').textContent = currentCalendarYear;
                console.log('API √ßaƒürƒ±sƒ± yapƒ±lƒ±yor:', `/controls/calendar.php?year=${currentCalendarYear}`);
                const response = await API.get(`/controls/calendar.php?year=${currentCalendarYear}`);
                
                console.log('API yanƒ±tƒ±:', response);
                
                if (response.success) {
                    console.log('Takvim verisi:', response.data);
                    displayCalendar(response.data);
                } else {
                    console.error('Takvim y√ºklenemedi:', response);
                    alert('Takvim y√ºklenemedi: ' + (response.message || 'Bilinmeyen hata'));
                }
            } catch (error) {
                console.error('Takvim y√ºkleme hatasƒ±:', error);
                alert('Takvim y√ºkleme hatasƒ±: ' + error.message);
            }
        }

        function changeCalendarYear(delta) {
            currentCalendarYear += delta;
            loadCalendar();
        }

        function displayCalendar(calendarData) {
            console.log('displayCalendar √ßaƒürƒ±ldƒ±, veri:', calendarData);
            const container = document.getElementById('calendarContainer');
            console.log('Container elementi:', container);
            
            if (!container) {
                console.error('calendarContainer elementi bulunamadƒ±!');
                return;
            }
            
            container.innerHTML = '';
            
            const monthNames = [
                'Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran',
                'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'
            ];
            const dayNames = ['Pzt', 'Sal', '√áar', 'Per', 'Cum', 'Cmt', 'Paz'];
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Her ay i√ßin takvim olu≈ütur
            for (let month = 0; month < 12; month++) {
                const monthDiv = document.createElement('div');
                monthDiv.className = 'calendar-month';
                
                const title = document.createElement('div');
                title.className = 'calendar-month-title';
                title.textContent = monthNames[month];
                monthDiv.appendChild(title);
                
                const grid = document.createElement('div');
                grid.className = 'calendar-grid';
                
                // G√ºn ba≈ülƒ±klarƒ±
                dayNames.forEach(day => {
                    const header = document.createElement('div');
                    header.className = 'calendar-day-header';
                    header.textContent = day;
                    grid.appendChild(header);
                });
                
                // Ayƒ±n ilk g√ºn√º hangi g√ºn ba≈ülƒ±yor
                const firstDay = new Date(currentCalendarYear, month, 1);
                let startingDayOfWeek = firstDay.getDay();
                // T√ºrkiye'de hafta pazartesi ba≈ülar (0=Paz, 1=Pzt)
                startingDayOfWeek = startingDayOfWeek === 0 ? 6 : startingDayOfWeek - 1;
                
                // Bo≈ü g√ºnler
                for (let i = 0; i < startingDayOfWeek; i++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.className = 'calendar-day empty';
                    grid.appendChild(emptyDay);
                }
                
                // Ayƒ±n g√ºnleri
                const daysInMonth = new Date(currentCalendarYear, month + 1, 0).getDate();
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${currentCalendarYear}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayData = calendarData.days[dateStr];
                    const currentDate = new Date(currentCalendarYear, month, day);
                    
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day';
                    dayDiv.textContent = day;
                    
                    // Bug√ºn m√º?
                    if (currentDate.getTime() === today.getTime()) {
                        dayDiv.classList.add('today');
                    }
                    
                    // Gelecek mi?
                    if (currentDate > today) {
                        dayDiv.classList.add('future');
                    } else if (dayData) {
                        dayDiv.classList.add(dayData.status);
                        dayDiv.title = `${dayData.completed_buildings}/${dayData.total_buildings} bina - %${Math.round(dayData.avg_completion || 0)} tamamlanma`;
                        dayDiv.onclick = () => showDayDetails(dateStr, dayData);
                    } else {
                        dayDiv.classList.add('none');
                        dayDiv.title = 'Kontrol yok';
                    }
                    
                    grid.appendChild(dayDiv);
                }
                
                monthDiv.appendChild(grid);
                container.appendChild(monthDiv);
            }
        }

        function showDayDetails(date, data) {
            alert(`üìÖ ${date}\n\n` +
                  `‚úÖ Kontrol Edilen Bina: ${data.completed_buildings}/${data.total_buildings}\n` +
                  `üìä Ortalama Tamamlanma: %${Math.round(data.avg_completion || 0)}\n` +
                  `üéØ Durum: ${data.status === 'complete' ? 'Tam Kontrol' : 
                              data.status === 'partial' ? 'Kƒ±smi Kontrol' : 'Kontrol Yok'}`);
        }
    </script>
</body>
</html>
